<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCM Interview Preparation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .step {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.5em;
            color: #2c3e50;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        select, textarea, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 200px;
            font-family: inherit;
            resize: vertical;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        .analysis-results {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 2px solid #667eea;
        }

        .competency-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #ddd;
        }

        .competency-item.strong {
            border-left-color: #28a745;
        }

        .competency-item.moderate {
            border-left-color: #ffc107;
        }

        .competency-item.weak {
            border-left-color: #fd7e14;
        }

        .competency-item.missing {
            border-left-color: #dc3545;
        }

        .competency-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .competency-evidence {
            font-size: 0.9em;
            color: #6c757d;
        }

        .strength-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }

        .strength-badge.strong {
            background: #d4edda;
            color: #155724;
        }

        .strength-badge.moderate {
            background: #fff3cd;
            color: #856404;
        }

        .strength-badge.weak {
            background: #ffe5d0;
            color: #d63384;
        }

        .strength-badge.missing {
            background: #f8d7da;
            color: #721c24;
        }

        .interview-assignments {
            margin-top: 30px;
        }

        .interviewer-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .interviewer-header {
            background: #667eea;
            color: white;
            padding: 15px;
            margin: -25px -25px 20px -25px;
            border-radius: 6px 6px 0 0;
            font-size: 1.3em;
            font-weight: bold;
        }

        .question-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .question-competency {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .question-text {
            color: #2c3e50;
            line-height: 1.6;
        }

        .form-container {
            background: white;
            padding: 40px;
            margin-bottom: 30px;
            border: 2px solid #ddd;
            border-radius: 8px;
            page-break-after: always;
        }

        .form-title {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .form-subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 30px;
        }

        .form-header-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .form-field {
            margin-bottom: 20px;
        }

        .form-field label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .form-field input, .form-field textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .competency-section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }

        .competency-title {
            font-size: 1.3em;
            font-weight: bold;
            color: white;
            background: #667eea;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .competency-definition {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-style: italic;
            color: #495057;
        }

        .probe-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .probe-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .themes-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .themes-column h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .theme-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .theme-item input[type="checkbox"] {
            margin-right: 8px;
            margin-top: 3px;
            width: auto;
        }

        .rating-section {
            margin: 20px 0;
            padding: 20px;
            background: #e9ecef;
            border-radius: 6px;
        }

        .rating-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .rating-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            margin: 0 5px;
        }

        .rating-option input[type="radio"] {
            margin-bottom: 5px;
            width: auto;
        }

        .rating-label {
            text-align: center;
            font-size: 0.85em;
            color: #495057;
        }

        .actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        /* Tabs UI */
        .tab-bar {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #eee;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .tab-btn {
            background: #f1f3f5;
            color: #2c3e50;
            border: none;
            padding: 8px 12px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-btn.active { background: #667eea; color: #fff; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container { box-shadow: none; }
            .header, .actions, button { display: none; }
            .form-container { border: none; padding: 20px; }
            /* By default, show all panels when printing */
            .tab-panel { display: block !important; }
            /* If we add this class, only print the active tab */
            .print-active-only .tab-panel { display: none !important; }
            .print-active-only .tab-panel.active { display: block !important; }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            .step {
                padding: 20px;
            }
            .form-header-fields {
                grid-template-columns: 1fr;
            }
            .themes-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ASCM Interview Preparation Tool</h1>
            <p>Powered by Korn Ferry Interview Architect‚Ñ¢</p>
        </div>

        <div class="main-content">
            <div id="setup-section">
                <!-- Step 1: Select Role -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h2 class="step-title">Select Success Profile</h2>
                    </div>
                    <label for="roleSelect">Choose the role you're interviewing for:</label>
                    <select id="roleSelect">
                        <option value="">-- Select Role --</option>
                        <option value="sdr">Sales Development Representative (SDR)</option>
                        <option value="kam">Key Account Manager (KAM)</option>
                        <option value="ae">Account Executive (Coming Soon)</option>
                    </select>
                </div>

                <!-- Step 2: Analyze Resume -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h2 class="step-title">Analyze Candidate Resume</h2>
                    </div>
                    <label for="candidateName">Candidate Name:</label>
                    <input type="text" id="candidateName" placeholder="Enter candidate's full name">
                    
                    <label for="resumeText" style="margin-top: 20px;">Paste Resume Content:</label>
                    <textarea id="resumeText" placeholder="Paste the candidate's resume here for analysis..."></textarea>
                    
                    <div style="text-align: center; margin: 15px 0; color: #6c757d; font-weight: 600;">- OR -</div>
                    
                    <label for="resumeFile">Upload Resume File (.TXT):</label>
                    <input type="file" id="resumeFile" accept=".txt" style="display: none;">
                    <button type="button" id="uploadBtn" class="secondary" onclick="document.getElementById('resumeFile').click()">
                        üìÅ Choose TXT File to Upload
                    </button>
                    <p style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">
                        <strong>Direct upload:</strong> TXT files only<br>
                        <strong>For PDF/DOC/DOCX:</strong> Please copy/paste text from the file into the text area above
                    </p>
                    <div id="fileNameDisplay" style="font-size: 0.9em; color: #667eea; margin-top: 5px; font-weight: 600;"></div>
                    
                    <button id="analyzeBtn">Analyze Resume</button>
                    
                    <div id="analysisResults" class="hidden"></div>
                </div>

                <!-- Step 3: Set Number of Interviewers -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <h2 class="step-title">Configure Interview Panel</h2>
                    </div>
                    <label for="numInterviewers">Number of Interviewers (2-4):</label>
                    <input type="number" id="numInterviewers" min="2" max="4" value="3">
                    
                    <button id="generateBtn" class="success">Generate Interview Assignments</button>
                </div>

                <!-- Step 4: Save/Load -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <h2 class="step-title">Save & Load</h2>
                    </div>
                    <button id="saveBtn" class="secondary">Save to Browser</button>
                    <button id="loadBtn" class="secondary">Load from Browser</button>
                    <button id="exportBtn" class="secondary">Export to File</button>
                    <label for="importFile" style="display: inline-block; margin-top: 10px;">
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                        <button type="button" class="secondary" onclick="document.getElementById('importFile').click()">Import from File</button>
                    </label>
                    <button id="resetPromptBtn" class="secondary" style="margin-left: 8px;">Reset Load Prompt</button>
                </div>

                <!-- Step 5: Public URL Configuration -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">5</div>
                        <h2 class="step-title">Configure Public URL for Sharing</h2>
                    </div>
                    <div class="alert alert-warning" style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                        <strong>‚ö†Ô∏è Important:</strong> Before sharing interview guide links with non-genspark.ai users, you MUST set the Public URL below.
                        <br><br>
                        <strong>Why?</strong> The default URL (genspark.ai/api/files/...) requires authentication and won't work for external users.
                        <br><br>
                        <strong>How to fix:</strong>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li>Deploy this tool to a public location (e.g., GitHub Pages, Netlify, Vercel, or any web hosting)</li>
                            <li>Copy the deployed URL (e.g., https://yoursite.github.io/interview-tool/index.html)</li>
                            <li>Paste it in the field below and click "Save Public URL"</li>
                            <li>Share links will now use your public URL instead</li>
                        </ol>
                        <br>
                        <strong>üí° Pro Tip:</strong> To always start with a fresh setup page (no auto-load), add <code>?fresh=1</code> to your URL:<br>
                        <code style="background: #fff; padding: 2px 6px; border-radius: 3px; font-size: 0.9em;">https://yoursite.github.io/interview-tool/index.html?fresh=1</code>
                    </div>
                    <label for="publicBaseUrlInput">Public/Deployed URL (where this tool is publicly accessible):</label>
                    <input type="text" id="publicBaseUrlInput" placeholder="https://yoursite.github.io/interview-tool/index.html" style="margin-bottom: 10px;">
                    <button id="savePublicUrlBtn" class="success">Save Public URL</button>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">
                        <strong>Current URL being used:</strong> <span id="currentPublicUrl" style="font-family: monospace; color: #667eea;"></span>
                    </p>
                </div>
            </div>

            <div id="results-section" class="hidden">
                <div class="alert alert-success">
                    Interview assignments generated successfully! Forms are ready below.
                </div>

                <div class="alert alert-info" style="display: flex; justify-content: space-between; align-items: center; background: #e7f3ff; border-left: 4px solid #2196F3;">
                    <div>
                        <strong>üí° Need to create a new interview?</strong> Click "Back to Setup" to start fresh or "Start New Assignment" to clear current data.
                    </div>
                    <button id="backToSetupBtn" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap; margin-left: 15px;">
                        ‚Üê Back to Setup
                    </button>
                </div>
                
                <div class="actions">
                    <button id="printAllBtn">Print All Forms</button>
                    <button id="printActiveBtn" class="secondary">Print Active Tab</button>
                    <button id="downloadPdfBtn" class="success">Download Active Tab as PDF</button>
                    <button id="exportActiveJsonBtn" class="secondary">Export Active Tab as JSON</button>
                    <button id="importActiveJsonBtn" class="secondary">Import Active Tab JSON</button>
                    <input type="file" id="importActiveJsonFile" accept=".json" style="display:none;" />
                    <button id="copyLinkBtn" class="secondary">Copy Active Tab Link</button>
                    <button id="saveActiveBtn" class="secondary">Save Active Notes</button>
                    <button id="saveAllBtn" class="secondary">Save to Browser</button>
                    <button id="newAssignmentBtn" class="secondary">Start New Assignment</button>
                </div>

                <div id="tabsBar" class="tab-bar hidden" role="tablist" aria-label="Interviewers"></div>
                <div id="shareLinks" class="alert alert-info hidden"><strong>Shareable links:</strong>
                    <ul id="shareLinksList" style="margin-top:8px; padding-left: 18px;"></ul>
                </div>
                <div id="formsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // COMPETENCY DATABASE
        const COMPETENCIES = {
            sdr: {
                thought: [
                    {
                        id: 5,
                        name: "Business Insight",
                        definition: "Applying knowledge of business and the marketplace to advance the organization's goals.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time your knowledge of marketplace trends influenced a decision you made.",
                            "Describe how your knowledge of business has been developed.",
                            "Explain how you keep yourself current on business practices and trends."
                        ],
                        positiveThemes: [
                            "Understands how businesses work",
                            "Aware of current business trends",
                            "Applies business knowledge to job",
                            "Understands the competition"
                        ],
                        negativeThemes: [
                            "Doesn't understand how businesses work",
                            "Not interested in broad business issues",
                            "Doesn't apply business knowledge",
                            "Too internally focused"
                        ]
                    },
                    {
                        id: 8,
                        name: "Manages Complexity",
                        definition: "Making sense of complex, high quantity, and sometimes contradictory information to effectively solve problems.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time you came up with a process or procedure to solve a problem.",
                            "Describe a time you were faced with a complex problem and had to get to the essence in a short time period.",
                            "Tell me about how you analyzed information and options to solve a persistent problem."
                        ],
                        positiveThemes: [
                            "Clearly defines the problem before acting",
                            "Can see root causes",
                            "Explores multiple sources for information",
                            "Understands what's relevant and what isn't"
                        ],
                        negativeThemes: [
                            "Sees things as more simple than they are",
                            "Doesn't take time to define the problem",
                            "Draws on limited sources of information",
                            "Allows intuition to override the facts"
                        ]
                    },
                    {
                        id: 22,
                        name: "Nimble Learning",
                        definition: "Actively learning through experimentation when tackling new problems, using both successes and failures as learning fodder.",
                        importance: "high",
                        category: "differentiator",
                        questions: [
                            "Tell me about a time when you had to learn something completely new.",
                            "Describe a situation where you had to quickly master new skills or knowledge.",
                            "Tell me about a time when you learned from a failure."
                        ],
                        positiveThemes: [
                            "Learns quickly from experience",
                            "Seeks out new learning opportunities",
                            "Applies learnings to new situations",
                            "Experiments and tries new approaches"
                        ],
                        negativeThemes: [
                            "Slow to learn from experience",
                            "Resists trying new approaches",
                            "Doesn't apply past learnings",
                            "Avoids unfamiliar situations"
                        ]
                    },
                    {
                        id: 33,
                        name: "Strategic Mindset",
                        definition: "Seeing ahead to future possibilities and translating them into breakthrough strategies.",
                        importance: "medium",
                        category: "differentiator",
                        questions: [
                            "Tell me about a time when you developed a strategy or plan for reaching a goal.",
                            "Describe how you approach planning for future possibilities.",
                            "Give an example of when you had to think several steps ahead."
                        ],
                        positiveThemes: [
                            "Anticipates future trends",
                            "Develops long-term strategies",
                            "Connects current actions to future outcomes",
                            "Sees the big picture"
                        ],
                        negativeThemes: [
                            "Focuses only on immediate tasks",
                            "Difficulty seeing beyond the present",
                            "Doesn't consider long-term implications",
                            "Reactive rather than proactive"
                        ]
                    }
                ],
                results: [
                    {
                        id: 2,
                        name: "Action Oriented",
                        definition: "Taking on new opportunities and tough challenges with a sense of urgency, high energy, and enthusiasm.",
                        importance: "critical",
                        category: "price-of-admission",
                        questions: [
                            "Tell me about a time you were the first person to take action on something.",
                            "Describe a time when you seized an opportunity and moved forward with it yourself.",
                            "Tell me about a situation that required an enormous amount of energy and effort."
                        ],
                        positiveThemes: [
                            "Willing to act without unnecessary planning",
                            "Identifies and seizes new opportunities",
                            "Takes a can-do approach",
                            "Steps up to handle tough issues",
                            "Shows initiative in tough situations"
                        ],
                        negativeThemes: [
                            "Slow to act on an opportunity",
                            "Spends too much time planning",
                            "Waits too long to act",
                            "Doesn't step up to challenges",
                            "Shows little initiative"
                        ]
                    },
                    {
                        id: 28,
                        name: "Drives Results",
                        definition: "Consistently achieving results, even under tough circumstances.",
                        importance: "critical",
                        category: "price-of-admission",
                        questions: [
                            "Tell me about a time when you had to push hard to achieve a difficult goal.",
                            "Describe a situation where you had to deliver results despite significant obstacles.",
                            "Give an example of when you exceeded performance expectations."
                        ],
                        positiveThemes: [
                            "Consistently meets or exceeds goals",
                            "Persists despite obstacles",
                            "Maintains high performance standards",
                            "Takes ownership of results"
                        ],
                        negativeThemes: [
                            "Inconsistent performance",
                            "Gives up when faced with obstacles",
                            "Makes excuses for poor results",
                            "Doesn't take ownership"
                        ]
                    },
                    {
                        id: 1,
                        name: "Ensures Accountability",
                        definition: "Holding self and others accountable to meet commitments.",
                        importance: "high",
                        category: "price-of-admission",
                        questions: [
                            "Recall a time you made a mistake while working with others and had to make it right.",
                            "Give me an example of a time you were unable to follow through on a commitment.",
                            "Describe your approach to monitoring progress and holding yourself accountable."
                        ],
                        positiveThemes: [
                            "Follows through on commitments",
                            "Takes personal responsibility",
                            "Works to determine clear standards",
                            "Establishes processes for measuring results"
                        ],
                        negativeThemes: [
                            "Doesn't accept personal responsibility",
                            "Prefers to share accountability",
                            "Doesn't see commitments through",
                            "Provides inadequate feedback"
                        ]
                    },
                    {
                        id: 38,
                        name: "Optimizes Work Processes",
                        definition: "Knowing the most effective and efficient processes to get things done, with a focus on continuous improvement.",
                        importance: "medium",
                        category: "competitive-edge",
                        questions: [
                            "Describe a time you had to organize and implement a work process.",
                            "Tell me about a time when you found yourself caught in an inefficient process and had to figure out a better way.",
                            "Give an example of how you improved a process or workflow."
                        ],
                        positiveThemes: [
                            "Gets to real issues and core essentials",
                            "Simplifies complex processes",
                            "Goal driven",
                            "Makes process improvements",
                            "Uses resources wisely"
                        ],
                        negativeThemes: [
                            "Impatient; lacks attention to detail",
                            "Can't project action steps",
                            "Disorganized",
                            "Doesn't develop process opportunities"
                        ]
                    }
                ],
                people: [
                    {
                        id: 11,
                        name: "Customer Focus",
                        definition: "Building strong customer relationships and delivering customer-centric solutions.",
                        importance: "critical",
                        category: "price-of-admission",
                        questions: [
                            "Tell me about a time when you had to understand a customer's needs quickly.",
                            "Describe a situation where you went above and beyond for a customer.",
                            "Give an example of how you built a strong relationship with a difficult customer."
                        ],
                        positiveThemes: [
                            "Understands customer needs and priorities",
                            "Builds strong customer relationships",
                            "Delivers customer-centric solutions",
                            "Responds quickly to customer concerns"
                        ],
                        negativeThemes: [
                            "Doesn't understand customer perspective",
                            "Focuses on own agenda",
                            "Poor relationship building",
                            "Slow to respond to customer needs"
                        ]
                    },
                    {
                        id: 7,
                        name: "Communicates Effectively",
                        definition: "Developing and delivering multi-mode communications that convey a clear understanding of the unique needs of different audiences.",
                        importance: "critical",
                        category: "price-of-admission",
                        questions: [
                            "Tell me about a time when you had to communicate something important to someone who did not understand your industry's language very well.",
                            "Tell me about a time when you had to communicate the same information to different audiences and had to vary your style for each.",
                            "Tell me about a time you were involved in a task that required you to communicate clearly and quickly."
                        ],
                        positiveThemes: [
                            "Effective with variety of communication methods",
                            "Listens attentively and actively",
                            "Adapts approach to the audience",
                            "Provides timely helpful information"
                        ],
                        negativeThemes: [
                            "Unclear in communication",
                            "Doesn't adjust to audience",
                            "Doesn't listen well",
                            "Doesn't share needed information"
                        ]
                    },
                    {
                        id: 6,
                        name: "Collaborates",
                        definition: "Building partnerships and working collaboratively with others to meet shared objectives.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you built strong relationships where none previously existed.",
                            "Describe a time you had to build partnerships to achieve a shared objective.",
                            "Tell me about a time you succeeded in an initiative by collaborating with others."
                        ],
                        positiveThemes: [
                            "Cooperates to achieve shared objectives",
                            "Considers others' interests",
                            "Partners with others to get work done",
                            "Gives credit for accomplishments",
                            "Is trusted by others"
                        ],
                        negativeThemes: [
                            "Misses opportunities to collaborate",
                            "Puts own interests first",
                            "Doesn't encourage communication",
                            "Doesn't give credit where due",
                            "Prefers to work alone"
                        ]
                    },
                    {
                        id: 20,
                        name: "Interpersonal Savvy",
                        definition: "Relating openly and comfortably with diverse groups of people.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you had to work with someone very different from you.",
                            "Describe a situation where you had to read someone's reactions and adjust your approach.",
                            "Give an example of how you built rapport with someone difficult."
                        ],
                        positiveThemes: [
                            "Relates well to diverse people",
                            "Reads social cues accurately",
                            "Builds rapport quickly",
                            "Adapts interpersonal style"
                        ],
                        negativeThemes: [
                            "Struggles with diverse personalities",
                            "Misses social cues",
                            "Difficulty building rapport",
                            "Inflexible interpersonal style"
                        ]
                    },
                    {
                        id: 24,
                        name: "Persuades",
                        definition: "Using compelling arguments to gain the support and commitment of others.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you had to convince someone to support your idea.",
                            "Describe a situation where you had to overcome significant resistance.",
                            "Give an example of how you influenced someone to change their mind."
                        ],
                        positiveThemes: [
                            "Uses compelling arguments",
                            "Gains support and commitment",
                            "Overcomes resistance effectively",
                            "Adapts persuasion approach"
                        ],
                        negativeThemes: [
                            "Weak arguments",
                            "Can't gain support",
                            "Gives up when resisted",
                            "One-size-fits-all approach"
                        ]
                    }
                ],
                self: [
                    {
                        id: 26,
                        name: "Being Resilient",
                        definition: "Rebounding from setbacks and adversity when facing difficult situations.",
                        importance: "most-critical",
                        category: "differentiator",
                        questions: [
                            "Tell me about a time when you faced significant rejection and how you handled it.",
                            "Describe a situation where you had to bounce back from a major setback.",
                            "Give an example of how you maintained your composure under extreme pressure."
                        ],
                        positiveThemes: [
                            "Rebounds quickly from setbacks",
                            "Maintains positive attitude",
                            "Learns from adversity",
                            "Stays composed under pressure",
                            "Persists despite challenges"
                        ],
                        negativeThemes: [
                            "Takes setbacks personally",
                            "Loses motivation after rejection",
                            "Becomes defensive or negative",
                            "Struggles under pressure",
                            "Gives up too easily"
                        ]
                    },
                    {
                        id: 29,
                        name: "Demonstrates Self-Awareness",
                        definition: "Using a combination of feedback and reflection to gain productive insight into personal strengths and weaknesses.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you received feedback that surprised you.",
                            "Describe how you identify your own strengths and weaknesses.",
                            "Give an example of when self-awareness helped you improve."
                        ],
                        positiveThemes: [
                            "Seeks and accepts feedback",
                            "Accurately assesses own capabilities",
                            "Recognizes impact on others",
                            "Open to self-reflection"
                        ],
                        negativeThemes: [
                            "Resists feedback",
                            "Inaccurate self-assessment",
                            "Unaware of impact on others",
                            "Defensive about weaknesses"
                        ]
                    },
                    {
                        id: 30,
                        name: "Self-Development",
                        definition: "Actively seeking new ways to grow and be challenged using both formal and informal development channels.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you took initiative to develop a new skill.",
                            "Describe how you approach your own professional development.",
                            "Give an example of when you sought out learning opportunities."
                        ],
                        positiveThemes: [
                            "Seeks growth opportunities",
                            "Takes initiative in development",
                            "Learns from multiple sources",
                            "Applies learning to improve"
                        ],
                        negativeThemes: [
                            "Waits for development opportunities",
                            "Resists learning new things",
                            "Limited learning sources",
                            "Doesn't apply learning"
                        ]
                    },
                    {
                        id: 31,
                        name: "Situational Adaptability",
                        definition: "Adapting approach and demeanor in real time to match shifting demands of different situations.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you had to quickly change your approach.",
                            "Describe a situation where you had to adapt to unexpected changes.",
                            "Give an example of how you adjusted your style for different people or situations."
                        ],
                        positiveThemes: [
                            "Adapts quickly to change",
                            "Flexible in approach",
                            "Reads situations well",
                            "Adjusts style effectively"
                        ],
                        negativeThemes: [
                            "Rigid in approach",
                            "Struggles with change",
                            "Misreads situations",
                            "One-size-fits-all style"
                        ]
                    },
                    {
                        id: 36,
                        name: "Instills Trust",
                        definition: "Gaining the confidence and trust of others through honesty, integrity, and authenticity.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you delivered bad news well.",
                            "Describe a time when full disclosure would have caused you personal loss.",
                            "Give an example of how you earned someone's trust."
                        ],
                        positiveThemes: [
                            "Acts with integrity",
                            "Honest and authentic",
                            "Keeps commitments",
                            "Admits mistakes",
                            "Maintains confidences"
                        ],
                        negativeThemes: [
                            "Lacks authenticity",
                            "Breaks commitments",
                            "Hides mistakes",
                            "Violates confidences",
                            "Acts for personal gain"
                        ]
                    }
                ]
            },
            kam: {
                thought: [
                    {
                        id: 11,
                        name: "Customer Focus",
                        definition: "Building strong customer relationships and delivering customer-centric solutions.",
                        importance: "critical",
                        category: "price-of-admission",
                        questions: [
                            "Tell me about a time when you had to understand a customer's needs quickly.",
                            "Describe a situation where you went above and beyond for a customer.",
                            "Give an example of how you built a strong relationship with a difficult customer."
                        ],
                        positiveThemes: [
                            "Understands customer needs and priorities",
                            "Builds strong customer relationships",
                            "Delivers customer-centric solutions",
                            "Responds quickly to customer concerns"
                        ],
                        negativeThemes: [
                            "Doesn't understand customer perspective",
                            "Focuses on own agenda",
                            "Poor relationship building",
                            "Slow to respond to customer needs"
                        ]
                    },
                    {
                        id: 8,
                        name: "Manages Complexity",
                        definition: "Making sense of complex, high quantity, and sometimes contradictory information to effectively solve problems.",
                        importance: "critical",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time you came up with a process or procedure to solve a problem.",
                            "Describe a time you were faced with a complex problem and had to get to the essence in a short time period.",
                            "Tell me about how you analyzed information and options to solve a persistent problem."
                        ],
                        positiveThemes: [
                            "Clearly defines the problem before acting",
                            "Can see root causes",
                            "Explores multiple sources for information",
                            "Understands what's relevant and what isn't"
                        ],
                        negativeThemes: [
                            "Sees things as more simple than they are",
                            "Doesn't take time to define the problem",
                            "Draws on limited sources of information",
                            "Allows intuition to override the facts"
                        ]
                    },
                    {
                        id: 33,
                        name: "Strategic Mindset",
                        definition: "Seeing ahead to future possibilities and translating them into breakthrough strategies.",
                        importance: "critical",
                        category: "differentiator",
                        questions: [
                            "Tell me about a time when you developed a strategy or plan for reaching a goal.",
                            "Describe how you approach planning for future possibilities.",
                            "Give an example of when you had to think several steps ahead."
                        ],
                        positiveThemes: [
                            "Anticipates future trends",
                            "Develops long-term strategies",
                            "Connects current actions to future outcomes",
                            "Sees the big picture"
                        ],
                        negativeThemes: [
                            "Focuses only on immediate tasks",
                            "Difficulty seeing beyond the present",
                            "Doesn't consider long-term implications",
                            "Reactive rather than proactive"
                        ]
                    },
                    {
                        id: 5,
                        name: "Business Insight",
                        definition: "Applying knowledge of business and the marketplace to advance the organization's goals.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time your knowledge of marketplace trends influenced a decision you made.",
                            "Describe how your knowledge of business has been developed.",
                            "Explain how you keep yourself current on business practices and trends."
                        ],
                        positiveThemes: [
                            "Understands how businesses work",
                            "Aware of current business trends",
                            "Applies business knowledge to job",
                            "Understands the competition"
                        ],
                        negativeThemes: [
                            "Doesn't understand how businesses work",
                            "Not interested in broad business issues",
                            "Doesn't apply business knowledge",
                            "Too internally focused"
                        ]
                    },
                    {
                        id: 17,
                        name: "Financial Acumen",
                        definition: "Interpreting and applying understanding of key financial indicators to make better business decisions.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you used financial data to make a business decision.",
                            "Describe how you evaluate the financial health of a client or opportunity.",
                            "Give an example of when financial considerations influenced your account strategy."
                        ],
                        positiveThemes: [
                            "Understands key financial metrics",
                            "Makes data-driven decisions",
                            "Can discuss financial implications",
                            "Connects activities to financial outcomes"
                        ],
                        negativeThemes: [
                            "Lacks financial understanding",
                            "Ignores financial implications",
                            "Can't discuss ROI or business case",
                            "Doesn't track financial performance"
                        ]
                    }
                ],
                results: [
                    {
                        id: 28,
                        name: "Drives Results",
                        definition: "Consistently achieving results, even under tough circumstances.",
                        importance: "critical",
                        category: "price-of-admission",
                        questions: [
                            "Tell me about a time when you had to push hard to achieve a difficult goal.",
                            "Describe a situation where you had to deliver results despite significant obstacles.",
                            "Give an example of when you exceeded performance expectations."
                        ],
                        positiveThemes: [
                            "Consistently meets or exceeds goals",
                            "Persists despite obstacles",
                            "Maintains high performance standards",
                            "Takes ownership of results"
                        ],
                        negativeThemes: [
                            "Inconsistent performance",
                            "Gives up when faced with obstacles",
                            "Makes excuses for poor results",
                            "Doesn't take ownership"
                        ]
                    },
                    {
                        id: 2,
                        name: "Action Oriented",
                        definition: "Taking on new opportunities and tough challenges with a sense of urgency, high energy, and enthusiasm.",
                        importance: "high",
                        category: "price-of-admission",
                        questions: [
                            "Tell me about a time you were the first person to take action on something.",
                            "Describe a time when you seized an opportunity and moved forward with it yourself.",
                            "Tell me about a situation that required an enormous amount of energy and effort."
                        ],
                        positiveThemes: [
                            "Willing to act without unnecessary planning",
                            "Identifies and seizes new opportunities",
                            "Takes a can-do approach",
                            "Steps up to handle tough issues"
                        ],
                        negativeThemes: [
                            "Slow to act on an opportunity",
                            "Spends too much time planning",
                            "Waits too long to act",
                            "Doesn't step up to challenges"
                        ]
                    },
                    {
                        id: 1,
                        name: "Ensures Accountability",
                        definition: "Holding self and others accountable to meet commitments.",
                        importance: "high",
                        category: "price-of-admission",
                        questions: [
                            "Recall a time you made a mistake while working with others and had to make it right.",
                            "Give me an example of a time you were unable to follow through on a commitment.",
                            "Describe your approach to monitoring progress and holding yourself accountable."
                        ],
                        positiveThemes: [
                            "Follows through on commitments",
                            "Takes personal responsibility",
                            "Works to determine clear standards",
                            "Establishes processes for measuring results"
                        ],
                        negativeThemes: [
                            "Doesn't accept personal responsibility",
                            "Prefers to share accountability",
                            "Doesn't see commitments through",
                            "Provides inadequate feedback"
                        ]
                    }
                ],
                people: [
                    {
                        id: 7,
                        name: "Communicates Effectively",
                        definition: "Developing and delivering multi-mode communications that convey a clear understanding of the unique needs of different audiences.",
                        importance: "critical",
                        category: "price-of-admission",
                        questions: [
                            "Tell me about a time when you had to communicate something important to someone who did not understand your industry's language very well.",
                            "Tell me about a time when you had to communicate the same information to different audiences and had to vary your style for each.",
                            "Tell me about a time you were involved in a task that required you to communicate clearly and quickly."
                        ],
                        positiveThemes: [
                            "Effective with variety of communication methods",
                            "Listens attentively and actively",
                            "Adapts approach to the audience",
                            "Provides timely helpful information"
                        ],
                        negativeThemes: [
                            "Unclear in communication",
                            "Doesn't adjust to audience",
                            "Doesn't listen well",
                            "Doesn't share needed information"
                        ]
                    },
                    {
                        id: 6,
                        name: "Collaborates",
                        definition: "Building partnerships and working collaboratively with others to meet shared objectives.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you built strong relationships where none previously existed.",
                            "Describe a time you had to build partnerships to achieve a shared objective.",
                            "Tell me about a time you succeeded in an initiative by collaborating with others."
                        ],
                        positiveThemes: [
                            "Cooperates to achieve shared objectives",
                            "Considers others' interests",
                            "Partners with others to get work done",
                            "Gives credit for accomplishments"
                        ],
                        negativeThemes: [
                            "Misses opportunities to collaborate",
                            "Puts own interests first",
                            "Doesn't encourage communication",
                            "Doesn't give credit where due"
                        ]
                    },
                    {
                        id: 21,
                        name: "Builds Networks",
                        definition: "Effectively building formal and informal relationship networks inside and outside the organization.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you leveraged your network to accomplish something.",
                            "Describe how you go about building and maintaining professional relationships.",
                            "Give an example of when a relationship you cultivated proved valuable."
                        ],
                        positiveThemes: [
                            "Actively builds relationships",
                            "Maintains broad network",
                            "Leverages relationships effectively",
                            "Invests time in networking"
                        ],
                        negativeThemes: [
                            "Doesn't build relationships proactively",
                            "Limited professional network",
                            "Doesn't maintain connections",
                            "Sees networking as unimportant"
                        ]
                    },
                    {
                        id: 24,
                        name: "Persuades",
                        definition: "Using compelling arguments to gain the support and commitment of others.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you had to convince someone to support your idea.",
                            "Describe a situation where you had to overcome significant resistance.",
                            "Give an example of how you influenced someone to change their mind."
                        ],
                        positiveThemes: [
                            "Uses compelling arguments",
                            "Gains support and commitment",
                            "Overcomes resistance effectively",
                            "Adapts persuasion approach"
                        ],
                        negativeThemes: [
                            "Weak arguments",
                            "Can't gain support",
                            "Gives up when resisted",
                            "One-size-fits-all approach"
                        ]
                    },
                    {
                        id: 20,
                        name: "Interpersonal Savvy",
                        definition: "Relating openly and comfortably with diverse groups of people.",
                        importance: "medium",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you had to work with someone very different from you.",
                            "Describe a situation where you had to read someone's reactions and adjust your approach.",
                            "Give an example of how you built rapport with someone difficult."
                        ],
                        positiveThemes: [
                            "Relates well to diverse people",
                            "Reads social cues accurately",
                            "Builds rapport quickly",
                            "Adapts interpersonal style"
                        ],
                        negativeThemes: [
                            "Struggles with diverse personalities",
                            "Misses social cues",
                            "Difficulty building rapport",
                            "Inflexible interpersonal style"
                        ]
                    }
                ],
                self: [
                    {
                        id: 36,
                        name: "Instills Trust",
                        definition: "Gaining the confidence and trust of others through honesty, integrity, and authenticity.",
                        importance: "critical",
                        category: "price-of-admission",
                        questions: [
                            "Tell me about a time when you delivered bad news well.",
                            "Describe a time when full disclosure would have caused you personal loss.",
                            "Give an example of how you earned someone's trust."
                        ],
                        positiveThemes: [
                            "Acts with integrity",
                            "Honest and authentic",
                            "Keeps commitments",
                            "Admits mistakes"
                        ],
                        negativeThemes: [
                            "Lacks authenticity",
                            "Breaks commitments",
                            "Hides mistakes",
                            "Violates confidences"
                        ]
                    },
                    {
                        id: 29,
                        name: "Demonstrates Self-Awareness",
                        definition: "Using a combination of feedback and reflection to gain productive insight into personal strengths and weaknesses.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you received feedback that surprised you.",
                            "Describe how you identify your own strengths and weaknesses.",
                            "Give an example of when self-awareness helped you improve."
                        ],
                        positiveThemes: [
                            "Seeks and accepts feedback",
                            "Accurately assesses own capabilities",
                            "Recognizes impact on others",
                            "Open to self-reflection"
                        ],
                        negativeThemes: [
                            "Resists feedback",
                            "Inaccurate self-assessment",
                            "Unaware of impact on others",
                            "Defensive about weaknesses"
                        ]
                    },
                    {
                        id: 31,
                        name: "Situational Adaptability",
                        definition: "Adapting approach and demeanor in real time to match the shifting demands of different situations.",
                        importance: "high",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you had to quickly change your approach.",
                            "Describe a situation where you had to adapt to unexpected changes.",
                            "Give an example of how you adjusted your style for different people or situations."
                        ],
                        positiveThemes: [
                            "Adapts quickly to change",
                            "Flexible in approach",
                            "Reads situations well",
                            "Adjusts style effectively"
                        ],
                        negativeThemes: [
                            "Rigid in approach",
                            "Struggles with change",
                            "Misreads situations",
                            "One-size-fits-all style"
                        ]
                    },
                    {
                        id: 3,
                        name: "Manages Ambiguity",
                        definition: "Operating effectively, even when things are not certain or the way forward is not clear.",
                        importance: "high",
                        category: "differentiator",
                        questions: [
                            "Tell me about a time when you had a problem and you didn't know what to do.",
                            "Tell me about a time when you had to make a decision and the information available was inadequate.",
                            "Describe a project where the outcome or process was unclear."
                        ],
                        positiveThemes: [
                            "Stays calm in uncomfortable situations",
                            "Willing to experiment",
                            "Comfortable without full picture",
                            "Flexible and adaptable"
                        ],
                        negativeThemes: [
                            "High need to stay in comfort zone",
                            "Likes clarity and certainty",
                            "High need for structure",
                            "Inflexible"
                        ]
                    },
                    {
                        id: 30,
                        name: "Self-Development",
                        definition: "Actively seeking new ways to grow and be challenged using both formal and informal development channels.",
                        importance: "medium",
                        category: "competitive-edge",
                        questions: [
                            "Tell me about a time when you took initiative to develop a new skill.",
                            "Describe how you approach your own professional development.",
                            "Give an example of when you sought out learning opportunities."
                        ],
                        positiveThemes: [
                            "Seeks growth opportunities",
                            "Takes initiative in development",
                            "Learns from multiple sources",
                            "Applies learning to improve"
                        ],
                        negativeThemes: [
                            "Waits for development opportunities",
                            "Resists learning new things",
                            "Limited learning sources",
                            "Doesn't apply learning"
                        ]
                    }
                ]
            }
        };

        // State management
        let currentState = {
            role: '',
            candidateName: '',
            resumeText: '',
            analysis: null,
            interviewers: [],
            numInterviewers: 3
        };

        // DOM Elements
        const roleSelect = document.getElementById('roleSelect');
        const candidateName = document.getElementById('candidateName');
        const resumeText = document.getElementById('resumeText');
        const resumeFile = document.getElementById('resumeFile');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisResults = document.getElementById('analysisResults');
        const numInterviewers = document.getElementById('numInterviewers');
        const generateBtn = document.getElementById('generateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importFile = document.getElementById('importFile');
        const resetPromptBtn = document.getElementById('resetPromptBtn');
        const setupSection = document.getElementById('setup-section');
        const resultsSection = document.getElementById('results-section');
        const formsContainer = document.getElementById('formsContainer');
        const tabsBar = document.getElementById('tabsBar');
        const newAssignmentBtn = document.getElementById('newAssignmentBtn');
        const printAllBtn = document.getElementById('printAllBtn');
        const printActiveBtn = document.getElementById('printActiveBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const exportActiveJsonBtn = document.getElementById('exportActiveJsonBtn');
        const importActiveJsonBtn = document.getElementById('importActiveJsonBtn');
        const importActiveJsonFile = document.getElementById('importActiveJsonFile');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const saveActiveBtn = document.getElementById('saveActiveBtn');
        const saveAllBtn = document.getElementById('saveAllBtn');
        const shareLinks = document.getElementById('shareLinks');
        const shareLinksList = document.getElementById('shareLinksList');
        const publicBaseUrlInput = document.getElementById('publicBaseUrlInput');
        const savePublicUrlBtn = document.getElementById('savePublicUrlBtn');
        const currentPublicUrl = document.getElementById('currentPublicUrl');
        const backToSetupBtn = document.getElementById('backToSetupBtn');

        // Event Listeners
        analyzeBtn.addEventListener('click', analyzeResume);
        resumeFile.addEventListener('change', handleResumeFileUpload);
        generateBtn.addEventListener('click', generateAssignments);
        saveBtn.addEventListener('click', saveToLocalStorage);
        loadBtn.addEventListener('click', loadFromLocalStorage);
        exportBtn.addEventListener('click', exportToFile);
        importFile.addEventListener('change', importFromFile);
        resetPromptBtn.addEventListener('click', () => {
            try {
                localStorage.removeItem('ascm_prompt_suppress');
                alert('Load prompt has been reset. You will be asked again on next visit if saved data exists.');
            } catch(e) { alert('Unable to reset: ' + e.message); }
        });
        newAssignmentBtn.addEventListener('click', startNew);
        printAllBtn.addEventListener('click', () => window.print());
        printActiveBtn.addEventListener('click', printActiveTab);
        downloadPdfBtn.addEventListener('click', downloadActiveTabAsPDF);
        exportActiveJsonBtn.addEventListener('click', exportActiveTabJSON);
        importActiveJsonBtn.addEventListener('click', () => importActiveJsonFile.click());
        importActiveJsonFile.addEventListener('change', importActiveTabFromFile);
        copyLinkBtn.addEventListener('click', copyActiveTabLink);
        saveActiveBtn.addEventListener('click', saveActiveTabData);
        if (saveAllBtn) saveAllBtn.addEventListener('click', saveAllTabsToBrowser);
        if (savePublicUrlBtn) savePublicUrlBtn.addEventListener('click', savePublicBaseUrl);
        if (backToSetupBtn) backToSetupBtn.addEventListener('click', backToSetup);

        // File Upload Handler
        function handleResumeFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileNameDisplay = document.getElementById('fileNameDisplay');
            fileNameDisplay.textContent = `üìÑ Loading: ${file.name}...`;
            fileNameDisplay.style.color = '#667eea';

            const fileName = file.name.toLowerCase();
            
            // Check file type
            if (fileName.endsWith('.txt')) {
                // Handle TXT files
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    resumeText.value = text;
                    fileNameDisplay.textContent = `‚úÖ Loaded: ${file.name} (${Math.round(text.length / 1024)} KB)`;
                    fileNameDisplay.style.color = '#28a745';
                };
                reader.onerror = function() {
                    showFileError(fileNameDisplay, file.name);
                };
                reader.readAsText(file);
            } else if (fileName.endsWith('.pdf') || fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
                // For PDF/DOC/DOCX, we can't extract text in browser without additional libraries
                // Show helpful message to user
                fileNameDisplay.innerHTML = `‚ö†Ô∏è <strong>${file.name}</strong> detected. For PDF/DOC/DOCX files:<br>
                    1. Open the file in your PDF viewer or Word<br>
                    2. Select all text (Ctrl+A or Cmd+A)<br>
                    3. Copy (Ctrl+C or Cmd+C)<br>
                    4. Paste into the text area above<br>
                    <small style="color: #667eea;">Note: Only .TXT files can be uploaded directly. We recommend copy/paste for other formats.</small>`;
                fileNameDisplay.style.color = '#856404';
                fileNameDisplay.style.background = '#fff3cd';
                fileNameDisplay.style.padding = '10px';
                fileNameDisplay.style.borderRadius = '6px';
                fileNameDisplay.style.marginTop = '10px';
                
                // Clear the file input
                event.target.value = '';
            } else {
                // Unknown file type
                fileNameDisplay.textContent = `‚ùå Unsupported file type. Please use .TXT files or copy/paste resume text.`;
                fileNameDisplay.style.color = '#dc3545';
                event.target.value = '';
            }
        }
        
        function showFileError(displayElement, fileName) {
            displayElement.textContent = `‚ùå Error loading ${fileName}. Please copy/paste the resume text instead.`;
            displayElement.style.color = '#dc3545';
        }

        // Resume Analysis Function
        function analyzeResume() {
            const role = roleSelect.value;
            const resume = resumeText.value.trim();
            const name = candidateName.value.trim();

            if (!role) {
                alert('Please select a role first.');
                return;
            }

            if (!resume) {
                alert('Please paste the candidate resume.');
                return;
            }

            if (!name) {
                alert('Please enter the candidate name.');
                return;
            }

            currentState.role = role;
            currentState.candidateName = name;
            currentState.resumeText = resume;

            // Perform sophisticated analysis
            const analysis = performSophisticatedAnalysis(role, resume);
            currentState.analysis = analysis;

            // Display results
            displayAnalysisResults(analysis);
        }

        function performSophisticatedAnalysis(role, resumeText) {
            const competencies = COMPETENCIES[role];
            const allCompetencies = [
                ...competencies.thought,
                ...competencies.results,
                ...competencies.people,
                ...competencies.self
            ];

            const resumeLower = resumeText.toLowerCase();
            const results = [];

            allCompetencies.forEach(comp => {
                const analysis = analyzeCompetencyEvidence(comp, resumeLower, resumeText);
                results.push({
                    ...comp,
                    strength: analysis.strength,
                    evidence: analysis.evidence,
                    priority: calculatePriority(comp, analysis.strength)
                });
            });

            // Sort by priority (highest first)
            results.sort((a, b) => b.priority - a.priority);

            return results;
        }

        function analyzeCompetencyEvidence(competency, resumeLower, resumeOriginal) {
            let score = 0;
            const evidencePoints = [];

            // Keywords and phrases for each competency
            const keywords = getCompetencyKeywords(competency.name);
            
            // Check for keyword matches
            keywords.forEach(keyword => {
                const regex = new RegExp(keyword, 'gi');
                const matches = resumeLower.match(regex);
                if (matches) {
                    score += matches.length;
                    evidencePoints.push(`Mentions "${keyword}"`);
                }
            });

            // Check for quantifiable achievements
            const numberPattern = /\d+[%$k]|\d+\s*(years|months|percent|clients|deals)/gi;
            const quantifiableMatches = resumeOriginal.match(numberPattern);
            if (quantifiableMatches && quantifiableMatches.length > 2) {
                score += 2;
                evidencePoints.push('Includes quantifiable achievements');
            }

            // Check for action verbs related to competency
            const actionVerbs = getCompetencyActionVerbs(competency.name);
            actionVerbs.forEach(verb => {
                if (resumeLower.includes(verb)) {
                    score += 1;
                    evidencePoints.push(`Uses action verb: "${verb}"`);
                }
            });

            // Check for recency (recent experience is stronger)
            const currentYear = new Date().getFullYear();
            const recentYears = [currentYear, currentYear - 1, currentYear - 2];
            recentYears.forEach(year => {
                if (resumeOriginal.includes(year.toString())) {
                    score += 0.5;
                }
            });

            // Determine strength level
            let strength;
            if (score >= 5) strength = 'strong';
            else if (score >= 3) strength = 'moderate';
            else if (score >= 1) strength = 'weak';
            else strength = 'missing';

            return {
                strength,
                evidence: evidencePoints.slice(0, 3).join('; ') || 'No clear evidence found in resume'
            };
        }

        function getCompetencyKeywords(competencyName) {
            const keywordMap = {
                'Business Insight': ['business', 'market', 'industry', 'competitive', 'strategy', 'analysis', 'trends'],
                'Manages Complexity': ['complex', 'multiple', 'prioritize', 'analyze', 'problem-solving', 'data'],
                'Nimble Learning': ['learn', 'training', 'certification', 'new', 'skill', 'develop', 'adapt'],
                'Strategic Mindset': ['strategy', 'plan', 'long-term', 'vision', 'forecast', 'future'],
                'Action Oriented': ['initiative', 'proactive', 'launched', 'started', 'led', 'drove'],
                'Drives Results': ['achieved', 'exceeded', 'delivered', 'results', 'quota', 'goal', 'target'],
                'Ensures Accountability': ['responsible', 'accountable', 'ownership', 'commitment', 'reliable'],
                'Optimizes Work Processes': ['process', 'efficiency', 'improved', 'streamlined', 'optimized'],
                'Customer Focus': ['customer', 'client', 'relationship', 'service', 'satisfaction', 'retention'],
                'Communicates Effectively': ['presentation', 'communication', 'wrote', 'presented', 'negotiated'],
                'Collaborates': ['team', 'collaboration', 'cross-functional', 'partnership', 'worked with'],
                'Interpersonal Savvy': ['relationship', 'rapport', 'stakeholder', 'interpersonal', 'networking'],
                'Persuades': ['persuaded', 'convinced', 'influenced', 'negotiated', 'closed', 'sold'],
                'Being Resilient': ['overcame', 'challenged', 'adversity', 'persistent', 'resilient', 'recovered'],
                'Demonstrates Self-Awareness': ['feedback', 'improvement', 'self-assessment', 'growth', 'coached'],
                'Self-Development': ['developed', 'learned', 'training', 'certification', 'education', 'course'],
                'Situational Adaptability': ['adapt', 'flexible', 'versatile', 'change', 'adjusted', 'pivoted'],
                'Instills Trust': ['integrity', 'trust', 'ethical', 'honest', 'transparent', 'credibility']
            };
            return keywordMap[competencyName] || [];
        }

        function getCompetencyActionVerbs(competencyName) {
            const verbMap = {
                'Action Oriented': ['initiated', 'launched', 'pioneered', 'spearheaded'],
                'Drives Results': ['achieved', 'exceeded', 'delivered', 'accomplished'],
                'Customer Focus': ['served', 'supported', 'assisted', 'advised'],
                'Communicates Effectively': ['presented', 'communicated', 'articulated', 'conveyed'],
                'Persuades': ['convinced', 'influenced', 'persuaded', 'negotiated'],
                'Being Resilient': ['overcame', 'recovered', 'persevered', 'persisted']
            };
            return verbMap[competencyName] || [];
        }

        function calculatePriority(competency, strength) {
            // Priority = importance weight + gap weight
            let importanceWeight = 0;
            if (competency.importance === 'most-critical') importanceWeight = 10;
            else if (competency.importance === 'critical') importanceWeight = 8;
            else if (competency.importance === 'high') importanceWeight = 6;
            else if (competency.importance === 'medium') importanceWeight = 4;

            let gapWeight = 0;
            if (strength === 'missing') gapWeight = 10;
            else if (strength === 'weak') gapWeight = 7;
            else if (strength === 'moderate') gapWeight = 4;
            else if (strength === 'strong') gapWeight = 1;

            // Bonus for differentiator competencies
            let categoryBonus = 0;
            if (competency.category === 'differentiator') categoryBonus = 3;
            else if (competency.category === 'competitive-edge') categoryBonus = 2;

            return importanceWeight + gapWeight + categoryBonus;
        }

        function displayAnalysisResults(analysis) {
            let html = '<h3>Resume Analysis Results</h3>';
            html += '<p style="margin-bottom: 20px;">Competencies ranked by interview priority (considering role criticality and candidate gaps):</p>';

            analysis.forEach((comp, index) => {
                html += `
                    <div class="competency-item ${comp.strength}">
                        <div class="competency-name">
                            ${index + 1}. ${comp.name}
                            <span class="strength-badge ${comp.strength}">${comp.strength.toUpperCase()}</span>
                        </div>
                        <div class="competency-evidence">${comp.evidence}</div>
                    </div>
                `;
            });

            analysisResults.innerHTML = html;
            analysisResults.classList.remove('hidden');
        }

        // Generate Interview Assignments
        function generateAssignments() {
            if (!currentState.analysis) {
                alert('Please analyze the resume first.');
                return;
            }

            const numInterviewersValue = parseInt(numInterviewers.value);
            if (numInterviewersValue < 2 || numInterviewersValue > 4) {
                alert('Number of interviewers must be between 2 and 4.');
                return;
            }

            currentState.numInterviewers = numInterviewersValue;

            // Select top priority competencies
            const topCompetencies = currentState.analysis.slice(0, numInterviewersValue * 3);

            // Distribute to interviewers
            const assignments = distributeToInterviewers(topCompetencies, numInterviewersValue);
            currentState.interviewers = assignments;

            // Generate forms
            generateForms(assignments);

            // Show results section
            setupSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
        }

        function distributeToInterviewers(competencies, numInterviewers) {
            const assignments = [];
            for (let i = 0; i < numInterviewers; i++) {
                assignments.push({
                    interviewerNumber: i + 1,
                    competencies: []
                });
            }

            // Round-robin distribution
            competencies.forEach((comp, index) => {
                const interviewerIndex = index % numInterviewers;
                if (assignments[interviewerIndex].competencies.length < 4) {
                    // Select a question for this competency
                    const questionIndex = Math.floor(Math.random() * comp.questions.length);
                    assignments[interviewerIndex].competencies.push({
                        ...comp,
                        selectedQuestion: comp.questions[questionIndex]
                    });
                }
            });

            return assignments;
        }

        function generateForms(assignments) {
            formsContainer.innerHTML = '';

            // Build a panel per interviewer
            assignments.forEach((interviewer, idx) => {
                const panel = document.createElement('div');
                panel.className = 'tab-panel';
                panel.id = `panel-${interviewer.interviewerNumber}`;
                panel.setAttribute('role', 'tabpanel');
                panel.dataset.interviewerIndex = idx;

                // Generate forms
                const notesForm = generateInterviewNotesForm(interviewer);
                const evalForm = generateEvaluationForm(interviewer);
                panel.appendChild(notesForm);
                panel.appendChild(evalForm);

                // Per-panel save button at the end of the forms
                const bottomActions = document.createElement('div');
                bottomActions.className = 'actions';
                bottomActions.innerHTML = `<button type="button" class="success" onclick="saveTabDataByIndex(${idx})">Save Interviewer ${interviewer.interviewerNumber} Notes</button>`;
                panel.appendChild(bottomActions);

                // If we have saved formData for this interviewer, apply it
                if (currentState.interviewers[idx] && currentState.interviewers[idx].formData) {
                    applyFormDataToContainer(panel, currentState.interviewers[idx].formData);
                }

                formsContainer.appendChild(panel);
            });

            // Build tabs
            buildTabs(assignments.length);
            renderShareLinks(assignments.length);
            // Set from hash if present
            const hp = getHashParams();
            if (hp.i && !isNaN(hp.i)) {
                const idx = Math.max(0, Math.min(assignments.length - 1, parseInt(hp.i, 10) - 1));
                setActiveTab(idx);
                if (hp.single === '1') {
                    tabsBar.classList.add('hidden');
                }
            } else {
                setActiveTab(0);
            }
        }

        function generateInterviewNotesForm(interviewer) {
            const container = document.createElement('div');
            container.className = 'form-container';

            let html = `
                <div class="form-title">INTERVIEW NOTES</div>
                <div class="form-subtitle">Interviewer ${interviewer.interviewerNumber} - ${currentState.candidateName}</div>
                
                <div class="form-header-fields">
                    <div class="form-field">
                        <label>Candidate:</label>
                        <input type="text" value="${currentState.candidateName}" />
                    </div>
                    <div class="form-field">
                        <label>Position:</label>
                        <input type="text" value="${roleSelect.options[roleSelect.selectedIndex].text}" />
                    </div>
                    <div class="form-field">
                        <label>Interviewer:</label>
                        <input type="text" placeholder="Enter your name" />
                    </div>
                    <div class="form-field">
                        <label>Date:</label>
                        <input type="text" value="${new Date().toLocaleDateString()}" />
                    </div>
                </div>
            `;

            interviewer.competencies.forEach(comp => {
                html += `
                    <div class="competency-section">
                        <div class="competency-title">${comp.name}</div>
                        <div class="competency-definition">${comp.definition}</div>
                        
                        <div style="margin: 15px 0;">
                            <strong>MAIN INTERVIEW QUESTION:</strong>
                            <div style="margin-top: 8px; padding: 10px; background: white; border-left: 4px solid #667eea;">
                                ${comp.selectedQuestion}
                            </div>
                        </div>

                        <div class="probe-section">
                            <div class="probe-label">SITUATION (Record main points to describe situation)</div>
                            <textarea rows="4"></textarea>
                        </div>

                        <div class="probe-section">
                            <div class="probe-label">A. ACTIONS: How did you approach it? How did you do it?</div>
                            <textarea rows="3" placeholder="Listen for specific action steps"></textarea>
                        </div>

                        <div class="probe-section">
                            <div class="probe-label">B. THINKING: Explain your thinking - why you selected that approach?</div>
                            <textarea rows="3" placeholder="Listen for rationale and consideration of alternatives"></textarea>
                        </div>

                        <div class="probe-section">
                            <div class="probe-label">C. OUTCOME: What was the result? What was the impact?</div>
                            <textarea rows="3"></textarea>
                        </div>

                        <div class="probe-section">
                            <div class="probe-label">D. LEARNINGS: What did you take away from that experience?</div>
                            <textarea rows="3" placeholder="Listen for principles or rules of thumb"></textarea>
                        </div>

                        <div class="probe-section">
                            <div class="probe-label">E. APPLICATION: Describe a time when you used those lessons in different situations</div>
                            <textarea rows="3"></textarea>
                        </div>

                        <div style="margin: 20px 0;">
                            <h4 style="margin-bottom: 10px;">IDENTIFY THEMES FROM CANDIDATE'S RESPONSES:</h4>
                            <div class="themes-grid">
                                <div class="themes-column">
                                    <h4 style="color: #28a745;">‚úì POSITIVE THEMES TO LOOK FOR:</h4>
                                    ${comp.positiveThemes.map(theme => `
                                        <div class="theme-item">
                                            <input type="checkbox" />
                                            <label>${theme}</label>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="themes-column">
                                    <h4 style="color: #dc3545;">‚úó NEGATIVE THEMES TO WATCH OUT FOR:</h4>
                                    ${comp.negativeThemes.map(theme => `
                                        <div class="theme-item">
                                            <input type="checkbox" />
                                            <label>${theme}</label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="rating-section">
                            <strong>OVERALL COMPETENCY RATING: Where would you rate this person on this competency?</strong>
                            <div class="rating-scale">
                                <div class="rating-option">
                                    <input type="radio" name="rating-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                    <div class="rating-label">1<br>Clearly Misses Requirements</div>
                                </div>
                                <div class="rating-option">
                                    <input type="radio" name="rating-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                    <div class="rating-label">2<br>Less than Requirements</div>
                                </div>
                                <div class="rating-option">
                                    <input type="radio" name="rating-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                    <div class="rating-label">3<br>Meets Requirements</div>
                                </div>
                                <div class="rating-option">
                                    <input type="radio" name="rating-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                    <div class="rating-label">4<br>Exceeds Requirements</div>
                                </div>
                                <div class="rating-option">
                                    <input type="radio" name="rating-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                    <div class="rating-label">5<br>Far Exceeds Requirements</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            return container;
        }

        function generateEvaluationForm(interviewer) {
            const container = document.createElement('div');
            container.className = 'form-container';

            let html = `
                <div class="form-title">CANDIDATE EVALUATION FORM</div>
                <div class="form-subtitle">Interviewer ${interviewer.interviewerNumber} - ${currentState.candidateName}</div>
                
                <div class="form-header-fields">
                    <div class="form-field">
                        <label>Candidate:</label>
                        <input type="text" value="${currentState.candidateName}" />
                    </div>
                    <div class="form-field">
                        <label>Position:</label>
                        <input type="text" value="${roleSelect.options[roleSelect.selectedIndex].text}" />
                    </div>
                    <div class="form-field">
                        <label>Interviewer:</label>
                        <input type="text" placeholder="Enter your name" />
                    </div>
                    <div class="form-field">
                        <label>Date:</label>
                        <input type="text" value="${new Date().toLocaleDateString()}" />
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">COMPETENCIES EVALUATED</h3>
            `;

            interviewer.competencies.forEach(comp => {
                html += `
                    <div class="rating-section" style="margin-bottom: 25px;">
                        <strong>${comp.name}</strong>
                        <div style="font-size: 0.9em; color: #6c757d; margin: 5px 0 10px 0;">${comp.definition}</div>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" name="eval-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                <div class="rating-label">1<br>Clearly Misses</div>
                            </div>
                            <div class="rating-option">
                                <input type="radio" name="eval-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                <div class="rating-label">2<br>Less than</div>
                            </div>
                            <div class="rating-option">
                                <input type="radio" name="eval-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                <div class="rating-label">3<br>Meets</div>
                            </div>
                            <div class="rating-option">
                                <input type="radio" name="eval-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                <div class="rating-label">4<br>Exceeds</div>
                            </div>
                            <div class="rating-option">
                                <input type="radio" name="eval-${comp.id}-interviewer-${interviewer.interviewerNumber}" />
                                <div class="rating-label">5<br>Far Exceeds</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <label style="font-weight: normal;">Comments:</label>
                            <textarea rows="2"></textarea>
                        </div>
                    </div>
                `;
            });

            html += `
                <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">LEARNING AGILITY ASSESSMENT</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                    <p style="margin-bottom: 15px;">Consider all responses during the interview and check statements that describe the candidate:</p>
                    
                    <div class="themes-grid">
                        <div>
                            <h4 style="color: #dc3545; margin-bottom: 10px;">PASSIVE / NON-LEARNERS</h4>
                            <div class="theme-item"><input type="checkbox" /><label>Takes path of least resistance</label></div>
                            <div class="theme-item"><input type="checkbox" /><label>Closed to ideas of others</label></div>
                            <div class="theme-item"><input type="checkbox" /><label>Avoids risks; prefers staying the same</label></div>
                            <div class="theme-item"><input type="checkbox" /><label>Closed; low interest in feedback</label></div>
                            <div class="theme-item"><input type="checkbox" /><label>Lives in the present only</label></div>
                        </div>
                        <div>
                            <h4 style="color: #28a745; margin-bottom: 10px;">ACTIVE / AGILE LEARNERS</h4>
                            <div class="theme-item"><input type="checkbox" /><label>Likes challenges</label></div>
                            <div class="theme-item"><input type="checkbox" /><label>Open to ideas of others</label></div>
                            <div class="theme-item"><input type="checkbox" /><label>Accepts personal risks; takes the lead</label></div>
                            <div class="theme-item"><input type="checkbox" /><label>Asks for feedback; seeks improvement</label></div>
                            <div class="theme-item"><input type="checkbox" /><label>Comfortable projecting into future</label></div>
                        </div>
                    </div>

                    <div class="rating-section" style="margin-top: 20px; background: white;">
                        <strong>OVERALL LEARNING AGILITY RATING:</strong>
                        <div class="rating-scale">
                            <div class="rating-option">
                                <input type="radio" name="learning-agility-${interviewer.interviewerNumber}" />
                                <div class="rating-label">1<br>Mostly Passive</div>
                            </div>
                            <div class="rating-option">
                                <input type="radio" name="learning-agility-${interviewer.interviewerNumber}" />
                                <div class="rating-label">2<br>More Passive</div>
                            </div>
                            <div class="rating-option">
                                <input type="radio" name="learning-agility-${interviewer.interviewerNumber}" />
                                <div class="rating-label">3<br>Mixed</div>
                            </div>
                            <div class="rating-option">
                                <input type="radio" name="learning-agility-${interviewer.interviewerNumber}" />
                                <div class="rating-label">4<br>More Agile</div>
                            </div>
                            <div class="rating-option">
                                <input type="radio" name="learning-agility-${interviewer.interviewerNumber}" />
                                <div class="rating-label">5<br>Mostly Agile</div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">OVERALL ASSESSMENT</h3>
                
                <div class="rating-section">
                    <strong>How do you rate this person relative to the standard for this position?</strong>
                    <div class="rating-scale">
                        <div class="rating-option">
                            <input type="radio" name="overall-standard-${interviewer.interviewerNumber}" />
                            <div class="rating-label">1<br>Well Below</div>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="overall-standard-${interviewer.interviewerNumber}" />
                            <div class="rating-label">2<br>Slightly Below</div>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="overall-standard-${interviewer.interviewerNumber}" />
                            <div class="rating-label">3<br>At Standard</div>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="overall-standard-${interviewer.interviewerNumber}" />
                            <div class="rating-label">4<br>Slightly Above</div>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="overall-standard-${interviewer.interviewerNumber}" />
                            <div class="rating-label">5<br>Well Above</div>
                        </div>
                    </div>
                </div>

                <div class="rating-section">
                    <strong>Can this individual grow to reach the standard for this position in a reasonable period?</strong>
                    <div class="rating-scale">
                        <div class="rating-option">
                            <input type="radio" name="growth-potential-${interviewer.interviewerNumber}" />
                            <div class="rating-label">1<br>20% Sure</div>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="growth-potential-${interviewer.interviewerNumber}" />
                            <div class="rating-label">2<br>40% Sure</div>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="growth-potential-${interviewer.interviewerNumber}" />
                            <div class="rating-label">3<br>60% Sure</div>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="growth-potential-${interviewer.interviewerNumber}" />
                            <div class="rating-label">4<br>80% Sure</div>
                        </div>
                        <div class="rating-option">
                            <input type="radio" name="growth-potential-${interviewer.interviewerNumber}" />
                            <div class="rating-label">5<br>100% Sure</div>
                        </div>
                    </div>
                </div>

                <div class="form-field" style="margin-top: 20px;">
                    <label>Additional Comments / Overall Impression:</label>
                    <textarea rows="5" placeholder="Provide any additional observations, concerns, or recommendations..."></textarea>
                </div>

                <div class="form-field" style="margin-top: 20px;">
                    <label>Recommendation:</label>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: normal;">
                            <input type="radio" name="recommendation-${interviewer.interviewerNumber}" style="width: auto; margin-right: 8px;" />
                            <strong style="color: #28a745;">Strongly Recommend</strong> - Exceptional candidate, should move forward immediately
                        </label>
                        <label style="display: block; margin-bottom: 8px; font-weight: normal;">
                            <input type="radio" name="recommendation-${interviewer.interviewerNumber}" style="width: auto; margin-right: 8px;" />
                            <strong style="color: #28a745;">Recommend</strong> - Good candidate, meets requirements
                        </label>
                        <label style="display: block; margin-bottom: 8px; font-weight: normal;">
                            <input type="radio" name="recommendation-${interviewer.interviewerNumber}" style="width: auto; margin-right: 8px;" />
                            <strong style="color: #ffc107;">Neutral</strong> - Mixed performance, needs discussion
                        </label>
                        <label style="display: block; margin-bottom: 8px; font-weight: normal;">
                            <input type="radio" name="recommendation-${interviewer.interviewerNumber}" style="width: auto; margin-right: 8px;" />
                            <strong style="color: #dc3545;">Do Not Recommend</strong> - Does not meet requirements
                        </label>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            return container;
        }

        // Tabs and per-interviewer helpers
        function buildTabs(count) {
            tabsBar.classList.remove('hidden');
            tabsBar.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.type = 'button';
                btn.textContent = `Interviewer ${i + 1}`;
                btn.setAttribute('role', 'tab');
                btn.setAttribute('aria-controls', `panel-${i + 1}`);
                btn.addEventListener('click', () => setActiveTab(i));
                tabsBar.appendChild(btn);
            }
        }

        function setActiveTab(index) {
            // Buttons
            const buttons = tabsBar.querySelectorAll('.tab-btn');
            buttons.forEach((b, i) => {
                if (i === index) b.classList.add('active'); else b.classList.remove('active');
            });
            // Panels
            const panels = formsContainer.querySelectorAll('.tab-panel');
            panels.forEach((p, i) => {
                if (i === index) p.classList.add('active'); else p.classList.remove('active');
            });
            // Reflect in hash
            const hp = getHashParams();
            const singlePart = hp.single ? `&single=${hp.single}` : '';
            location.hash = `i=${index + 1}${singlePart}`;
        }

        function getActiveTabIndex() {
            const panels = formsContainer.querySelectorAll('.tab-panel');
            for (let i = 0; i < panels.length; i++) {
                if (panels[i].classList.contains('active')) return i;
            }
            return 0;
        }

        function getHashParams() {
            const h = (location.hash || '').replace(/^#/, '');
            const obj = {};
            h.split('&').forEach(p => {
                const [k, v] = p.split('=');
                if (k) obj[decodeURIComponent(k)] = decodeURIComponent(v || '');
            });
            return obj;
        }

        window.addEventListener('hashchange', () => {
            const hp = getHashParams();
            if (!resultsSection.classList.contains('hidden') && hp.i && !isNaN(hp.i)) {
                const idx = parseInt(hp.i, 10) - 1;
                setActiveTab(idx);
                if (hp.single === '1') tabsBar.classList.add('hidden'); else tabsBar.classList.remove('hidden');
            }
        });

        function collectFormDataFromContainer(container) {
            const snapshot = [];
            const elements = container.querySelectorAll('input, textarea, select');
            elements.forEach(el => {
                const entry = { t: el.tagName.toLowerCase(), type: el.type, v: null, c: null, n: el.name || '' };
                if (el.type === 'checkbox') {
                    entry.c = !!el.checked;
                } else if (el.type === 'radio') {
                    entry.c = !!el.checked;
                    entry.v = el.value || '';
                } else {
                    entry.v = el.value;
                }
                snapshot.push(entry);
            });
            return snapshot;
        }

        function applyFormDataToContainer(container, snapshot) {
            const elements = container.querySelectorAll('input, textarea, select');
            elements.forEach((el, idx) => {
                const entry = snapshot[idx];
                if (!entry) return;
                if (el.type === 'checkbox') {
                    el.checked = !!entry.c;
                } else if (el.type === 'radio') {
                    el.checked = !!entry.c; // relies on same order
                } else {
                    el.value = entry.v ?? '';
                }
            });
        }

        function saveActiveTabData() {
            const activeIndex = getActiveTabIndex();
            saveTabDataByIndex(activeIndex);
        }

        function saveTabDataByIndex(index) {
            const panel = formsContainer.querySelectorAll('.tab-panel')[index];
            if (!panel) { alert('Nothing to save yet.'); return; }
            const data = collectFormDataFromContainer(panel);
            if (!currentState.interviewers[index]) {
                currentState.interviewers[index] = { interviewerNumber: index + 1, competencies: [], formData: [] };
            }
            currentState.interviewers[index].formData = data;
            saveToLocalStorage();
            alert('Interviewer ' + (index + 1) + ' notes saved.');
        }

        async function ensureHtml2PdfLoaded() {
            if (window.html2pdf) return true;
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
                s.onload = () => resolve(true);
                s.onerror = () => reject(new Error('Failed to load PDF library'));
                document.head.appendChild(s);
            });
        }

        async function downloadActiveTabAsPDF() {
            try {
                await ensureHtml2PdfLoaded();
                const activeIndex = getActiveTabIndex();
                const panel = formsContainer.querySelectorAll('.tab-panel')[activeIndex];
                const interviewerLabel = `interviewer-${activeIndex + 1}`;
                const opt = {
                    margin:       0.5,
                    filename:     `interview-${(currentState.candidateName||'candidate').replace(/\s+/g,'-')}-${interviewerLabel}.pdf`,
                    image:        { type: 'jpeg', quality: 0.95 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                window.html2pdf().set(opt).from(panel).save();
            } catch (e) {
                alert('Unable to generate PDF in-browser. Use Print Active Tab and select "Save as PDF". Error: ' + e.message);
            }
        }

        function printActiveTab() {
            document.body.classList.add('print-active-only');
            window.print();
            setTimeout(() => document.body.classList.remove('print-active-only'), 500);
        }

        function saveAllTabsToBrowser() {
            const panels = formsContainer.querySelectorAll('.tab-panel');
            if (!panels.length) {
                saveToLocalStorage();
                alert('Saved.');
                return;
            }
            panels.forEach((panel, i) => {
                const data = collectFormDataFromContainer(panel);
                if (!currentState.interviewers[i]) {
                    currentState.interviewers[i] = { interviewerNumber: i + 1, competencies: [], formData: [] };
                }
                currentState.interviewers[i].formData = data;
            });
            saveToLocalStorage();
            alert('All interviewer notes saved to browser.');
        }

        function getPublicBaseUrl() {
            try {
                const saved = (localStorage.getItem('ascm_public_base_url') || '').trim();
                if (saved) return saved.replace(/[?#].*$/, '');
            } catch(e) {}
            return (location.href || '').split('#')[0];
        }

        function initPublicBaseUrlUI() {
            try {
                const saved = localStorage.getItem('ascm_public_base_url') || '';
                if (publicBaseUrlInput) publicBaseUrlInput.value = saved;
                if (currentPublicUrl) {
                    const displayUrl = getPublicBaseUrl();
                    currentPublicUrl.textContent = displayUrl;
                    // Show warning if using genspark.ai API URL
                    if (displayUrl.includes('genspark.ai/api/files')) {
                        currentPublicUrl.style.color = '#dc3545';
                        currentPublicUrl.title = 'WARNING: This is an authenticated URL and will not work for external users!';
                    } else {
                        currentPublicUrl.style.color = '#667eea';
                        currentPublicUrl.title = '';
                    }
                }
            } catch(e) {}
        }

        function savePublicBaseUrl() {
            try {
                const val = (publicBaseUrlInput.value || '').trim();
                if (val && !/^https?:\/\//i.test(val)) {
                    alert('Please enter a valid absolute URL starting with http:// or https://');
                    return;
                }
                localStorage.setItem('ascm_public_base_url', val);
                initPublicBaseUrlUI(); // Update the display
                renderShareLinks(currentState.numInterviewers || (currentState.interviewers||[]).length || 0);
                alert('Public URL saved. Share links updated.');
            } catch(e) { alert('Unable to save: ' + e.message); }
        }

        function generateShareLink(index, singleOnly=true) {
            const base = getPublicBaseUrl();
            const hash = `#i=${index + 1}${singleOnly ? '&single=1' : ''}`;
            return base + hash;
        }

        function copyActiveTabLink() {
            const idx = getActiveTabIndex();
            copyLinkFor(idx);
        }

        function copyLinkFor(idx) {
            const link = generateShareLink(idx, true);
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(link).then(() => alert('Link copied for Interviewer ' + (idx + 1))).catch(() => fallbackCopy(link));
            } else {
                fallbackCopy(link);
            }
        }

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); alert('Link copied.'); } catch(e) { alert('Copy failed. Here is the link:\n' + text); }
            document.body.removeChild(ta);
        }

        function exportActiveTabJSON() {
            const idx = getActiveTabIndex();
            const panel = formsContainer.querySelectorAll('.tab-panel')[idx];
            const snapshot = collectFormDataFromContainer(panel);
            const interviewer = currentState.interviewers[idx] || { interviewerNumber: idx + 1, competencies: [] };
            const roleText = roleSelect.options[roleSelect.selectedIndex]?.text || currentState.role || '';
            const payload = {
                version: '1.2.2',
                exported_at: new Date().toISOString(),
                candidateName: currentState.candidateName,
                role: roleText,
                interviewerNumber: interviewer.interviewerNumber,
                competencies: (interviewer.competencies || []).map(c => ({ id: c.id, name: c.name, question: c.selectedQuestion })),
                formDataSnapshot: snapshot
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interview-notes-${(currentState.candidateName||'candidate').replace(/\s+/g,'-')}-interviewer-${idx+1}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importActiveTabFromFile(evt) {
            const file = evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const obj = JSON.parse(e.target.result);
                    const idx = getActiveTabIndex();
                    const panel = formsContainer.querySelectorAll('.tab-panel')[idx];
                    if (!obj || !Array.isArray(obj.formDataSnapshot)) throw new Error('Invalid file format');
                    applyFormDataToContainer(panel, obj.formDataSnapshot);
                    // Save into state for persistence
                    if (!currentState.interviewers[idx]) {
                        currentState.interviewers[idx] = { interviewerNumber: idx + 1, competencies: [], formData: [] };
                    }
                    currentState.interviewers[idx].formData = obj.formDataSnapshot;
                    saveToLocalStorage();
                    alert('Active tab notes imported.');
                } catch (err) {
                    alert('Import failed: ' + err.message);
                } finally {
                    evt.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function renderShareLinks(count) {
            shareLinksList.innerHTML = '';
            shareLinks.classList.remove('hidden');
            for (let i = 0; i < count; i++) {
                const li = document.createElement('li');
                li.style.marginBottom = '6px';
                const link = generateShareLink(i, true);
                li.innerHTML = `Interviewer ${i+1}: <button type="button" style="margin-left:8px; padding:4px 8px; background:#667eea; color:#fff; border:none; border-radius:4px; cursor:pointer;">Copy link</button> <span style="color:#6c757d; font-size:0.9em;">${link}</span>`;
                const btn = li.querySelector('button');
                btn.addEventListener('click', () => copyLinkFor(i));
                shareLinksList.appendChild(li);
            }
        }

        // Save/Load Functions
        function saveToLocalStorage() {
            try {
                localStorage.setItem('ascm_interview_data', JSON.stringify(currentState));
                alert('Successfully saved to browser storage!');
            } catch (e) {
                alert('Error saving data: ' + e.message);
            }
        }

        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('ascm_interview_data');
                if (data) {
                    currentState = JSON.parse(data);
                    
                    // Restore form values
                    roleSelect.value = currentState.role;
                    candidateName.value = currentState.candidateName;
                    resumeText.value = currentState.resumeText;
                    numInterviewers.value = currentState.numInterviewers;
                    
                    if (currentState.analysis) {
                        displayAnalysisResults(currentState.analysis);
                    }
                    
                    if (currentState.interviewers.length > 0) {
                        generateForms(currentState.interviewers);
                        setupSection.classList.add('hidden');
                        resultsSection.classList.remove('hidden');
                    }
                    
                    alert('Successfully loaded data!');
                } else {
                    alert('No saved data found.');
                }
            } catch (e) {
                alert('Error loading data: ' + e.message);
            }
        }

        function exportToFile() {
            try {
                const dataStr = JSON.stringify(currentState, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `interview-assignment-${currentState.candidateName.replace(/\s+/g, '-')}-${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                alert('Error exporting data: ' + e.message);
            }
        }

        function importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    currentState = JSON.parse(e.target.result);
                    
                    // Restore form values
                    roleSelect.value = currentState.role;
                    candidateName.value = currentState.candidateName;
                    resumeText.value = currentState.resumeText;
                    numInterviewers.value = currentState.numInterviewers;
                    
                    if (currentState.analysis) {
                        displayAnalysisResults(currentState.analysis);
                    }
                    
                    if (currentState.interviewers.length > 0) {
                        generateForms(currentState.interviewers);
                        setupSection.classList.add('hidden');
                        resultsSection.classList.remove('hidden');
                    }
                    
                    alert('Successfully imported data!');
                } catch (err) {
                    alert('Error importing file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function startNew() {
            if (confirm('Start a new assignment? Current data will be cleared unless saved.')) {
                currentState = {
                    role: '',
                    candidateName: '',
                    resumeText: '',
                    analysis: null,
                    interviewers: [],
                    numInterviewers: 3
                };
                
                roleSelect.value = '';
                candidateName.value = '';
                resumeText.value = '';
                numInterviewers.value = 3;
                analysisResults.classList.add('hidden');
                analysisResults.innerHTML = '';
                formsContainer.innerHTML = '';
                
                setupSection.classList.remove('hidden');
                resultsSection.classList.add('hidden');
            }
        }

        function backToSetup() {
            // Simply show setup section and hide results, keeping data intact
            setupSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            
            // Scroll to top for better UX
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Auto-load on page load
        window.addEventListener('load', function() {
            initPublicBaseUrlUI();
            const savedData = localStorage.getItem('ascm_interview_data');
            const suppressKey = 'ascm_prompt_suppress';
            // Auto-load rules:
            // - If ?fresh=1 parameter exists, NEVER auto-load (start fresh)
            // - If URL hash contains i= (deep link), Auto-load if saved data exists
            // - If ?auto=1 in URL search, auto load silently
            // - If user suppressed previously, DO NOT prompt (for non-deeplink)
            const hp = getHashParams();
            const urlParams = new URLSearchParams(location.search);
            const deepLink = !!hp.i;
            const autoParam = urlParams.get('auto') === '1';
            const freshParam = urlParams.get('fresh') === '1';
            const suppressed = localStorage.getItem(suppressKey) === '1';

            // If ?fresh=1 is in URL, skip all auto-loading
            if (freshParam) {
                console.log('Fresh start requested via URL parameter. Skipping auto-load.');
                return;
            }

            if (savedData && deepLink) {
                // Deep link + saved state: load quietly, then generateForms will switch tab
                loadFromLocalStorage();
            } else if (savedData && !deepLink && !suppressed) {
                if (autoParam) {
                    loadFromLocalStorage();
                } else {
                    const ask = confirm('Found saved data. Load it now? Click Cancel to stop showing this message.');
                    if (ask) {
                        loadFromLocalStorage();
                    } else {
                        localStorage.setItem(suppressKey, '1');
                    }
                }
            } else if (deepLink && !savedData) {
                // No saved assignment yet: user followed a tab link without data
                // We keep them on setup and inform
                console.warn('Deep link detected, but no saved data found. Load/import data or generate assignments first.');
            }
        });
    </script>
</body>
</html>